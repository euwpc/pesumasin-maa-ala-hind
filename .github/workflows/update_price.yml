name: Update Price

on:
  schedule:
    - cron: "0 */2 * * *"   # every 2 hours
  workflow_dispatch:

jobs:
  update-price:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Update price.json
        run: |
          echo "Updating price.json..."

          # If price.json doesn't exist, create a default one
          if [ ! -f price.json ]; then
            echo '{"price":50,"history":[],"next_change_prediction":0}' > price.json
          fi

          node << 'EOF'
          const fs = require('fs');

          let data = JSON.parse(fs.readFileSync('price.json', 'utf8'));

          // ------------------------------
          // NEW IMPROVED RANDOM SYSTEM
          // ------------------------------
          function randomWeightedChange() {
              // 65% chance down, 35% chance up
              const direction = Math.random() < 0.65 ? -1 : 1;

              const rarityRoll = Math.random() * 100;
              let magnitude;

              if (rarityRoll < 70) {
                  magnitude = 1 + Math.floor(Math.random() * 5);     // 1–5 common (70%)
              } else if (rarityRoll < 90) {
                  magnitude = 5 + Math.floor(Math.random() * 5);     // 5–10 uncommon (20%)
              } else if (rarityRoll < 98) {
                  magnitude = 10 + Math.floor(Math.random() * 5);    // 10–15 rare (8%)
              } else if (rarityRoll < 99.9) {
                  magnitude = 20 + Math.floor(Math.random() * 10);   // 20–30 extremely rare (1.9%)
              } else {
                  magnitude = 30 + Math.floor(Math.random() * 20);   // SUPER RARE 30–50 (0.1%)
              }

              return direction * magnitude;
          }

          function rarityFromChange(change) {
              const abs = Math.abs(change);
              if (abs <= 5) return "Common";
              if (abs <= 10) return "Uncommon";
              if (abs <= 15) return "Rare";
              if (abs <= 30) return "Extremely Rare";
              return "Super Rare";
          }

          // ------------------------------
          // PRICE UPDATE LOGIC
          // ------------------------------
          const change = randomWeightedChange();
          let newPrice = data.price + change;
          if (newPrice < 1) newPrice = 1; // never below 1

          const nextChange = randomWeightedChange();

          data.price = newPrice;
          data.next_change_prediction = Math.abs(nextChange);

          data.history.unshift({
              change: change,
              rarity: rarityFromChange(change),
              timestamp: new Date().toISOString()
          });

          data.history = data.history.slice(0, 200);

          fs.writeFileSync('price.json', JSON.stringify(data, null, 4));
          EOF

      - name: Commit updated price.json
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"

          git add price.json
          git commit -m "Update price" || echo "No changes to commit"
          git push
